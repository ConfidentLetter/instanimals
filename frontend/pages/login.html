<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login - Instanimals</title>
        <link rel="stylesheet" href="/pages/styles.css" />
    </head>
    <body>
        <nav class="nav">
            <div class="container nav-inner">
                <a class="home-badge" href="/" style="flex-direction: row; width: auto; gap: 8px; text-decoration: none;">
                    <div class="home-icon">
                        <img
                            class="logo-ico"
                            src="/assets/success/house-badge.png"
                            alt="logo"
                        />
                    </div>
                    <div class="home-text">Home</div>
                </a>
                <div class="nav-links">
                    <a href="/#stories">Success Stories</a>
                    <a href="/#how">How it Works</a>
                    <a href="/pages/login.html">Login</a>
                    <div class="user-pill">ðŸ‘¤</div>
                </div>
            </div>
        </nav>

        <main class="login-wrap">
            <div class="container">
                <h1 class="section-title" id="pageTitle">Login</h1>
                <div class="section-sub" id="pageSub">
                    Thank you for being a foster family
                </div>

                <div class="form-card login-card">
                    <form id="authForm">
                        <div id="signupFields" style="display: none;">
                            <div class="field" style="margin-bottom: 14px;">
                                <label>Username</label>
                                <input
                                    id="username"
                                    type="text"
                                    placeholder="Choose a username"
                                />
                            </div>
                        </div>
                        <div class="field">
                            <label>Email Address</label>
                            <input
                                id="email"
                                type="email"
                                placeholder="you@email.com"
                                style="margin-bottom: 14px;"
                            />
                        </div>
                        <div class="field">
                            <label>Password</label>
                            <input
                                id="password"
                                type="password"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            />
                        </div>

                        <div style="text-align: center; margin-top: 24px">
                            <button class="btn" id="primaryBtn" type="button" style="width: 100%;">
                                Login
                            </button>
                            <div style="margin-top: 16px; font-size: 13px; color: var(--brown2); font-weight: 800;">
                                <span id="switchText">Don't have an account?</span>
                                <a href="javascript:void(0)" id="switchBtn" style="color: var(--accent); margin-left: 4px; text-decoration: none; font-weight: 1000;">Register</a>
                            </div>
                            
                            <button
                                class="btn secondary"
                                id="logoutBtn"
                                type="button"
                                style="display: none; width: 100%; margin-top: 10px"
                            >
                                Logout
                            </button>
                        </div>

                        <div
                            class="notice"
                            id="authStatus"
                            style="margin-top: 14px; text-align: center; font-weight: 800; color: var(--accent); font-size: 13px; min-height: 1em;"
                        ></div>

                        <div class="small" style="margin-top: 20px; border-top: 1.5px solid var(--line); padding-top: 15px; text-align: center;">
                            Tip: Your account works across the entire Instanimals platform.
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <script>
            const $ = (id) => document.getElementById(id);
            const statusEl = $("authStatus");
            const primaryBtn = $("primaryBtn");
            const logoutBtn = $("logoutBtn");
            const pageTitle = $("pageTitle");
            const pageSub = $("pageSub");
            const switchBtn = $("switchBtn");
            const switchText = $("switchText");
            const signupFields = $("signupFields");

            let isSignup = new URLSearchParams(window.location.search).get("mode") === "signup";

            function updateUI() {
                if (isSignup) {
                    pageTitle.textContent = "Create Account";
                    pageSub.textContent = "Join the Instanimals family";
                    primaryBtn.textContent = "Register";
                    switchText.textContent = "Already have an account?";
                    switchBtn.textContent = "Login";
                    signupFields.style.display = "block";
                } else {
                    pageTitle.textContent = "Login";
                    pageSub.textContent = "Thank you for being a foster family";
                    primaryBtn.textContent = "Login";
                    switchText.textContent = "Don't have an account?";
                    switchBtn.textContent = "Register";
                    signupFields.style.display = "none";
                }
                statusEl.textContent = "";
            }

            switchBtn.addEventListener("click", () => {
                isSignup = !isSignup;
                const newUrl = window.location.pathname + (isSignup ? "?mode=signup" : "");
                window.history.pushState({}, "", newUrl);
                updateUI();
            });

            updateUI();

            function setStatus(msg) {
                statusEl.textContent = msg;
            }
            function setBusy(isBusy) {
                primaryBtn.disabled = isBusy;
                primaryBtn.textContent = isBusy ? "Working..." : (isSignup ? "Register" : "Login");
            }

            primaryBtn.addEventListener("click", async () => {
                const email = $("email").value.trim();
                const password = $("password").value;
                const username = $("username")?.value.trim();

                if (!email || !password || (isSignup && !username))
                    return setStatus("Please fill in all fields.");

                setBusy(true);
                try {
                    const endpoint = isSignup ? "/api/signup" : "/api/login";
                    const body = isSignup ? { email, password, username } : { email, password };
                    
                    const res = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body)
                    });
                    
                    const data = await res.json();
                    
                    if (!res.ok) {
                        setStatus(data.message || "An error occurred.");
                    } else {
                        setStatus(isSignup ? "Account created! Redirecting..." : "Logged in! Redirecting...");
                        localStorage.setItem("token", data.email || email);
                        localStorage.setItem("user_profile", JSON.stringify({
                            name: data.username,
                            handle: data.handle || data.username,
                            avatarSeed: data.username
                        }));
                        setTimeout(() => {
                            location.href = "/";
                        }, 1000);
                    }
                } catch (err) {
                    console.error(err);
                    setStatus("Network error. Please try again.");
                } finally {
                    setBusy(false);
                }
            });

            // Check if already logged in
            if (localStorage.getItem("token")) {
                statusEl.textContent = `Already logged in as ${localStorage.getItem("token")}`;
                logoutBtn.style.display = "block";
            }

            logoutBtn.addEventListener("click", () => {
                localStorage.clear();
                location.reload();
            });
        </script>
    </body>
</html>
